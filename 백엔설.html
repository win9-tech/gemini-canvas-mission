<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>백엔설 (Back-An-Swer)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .hidden-step { display: none; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen p-4 md:p-8">
<div class="max-w-3xl mx-auto">
    <!-- Header -->
    <header class="mb-10 text-center">
        <div class="inline-flex items-center justify-center p-3 bg-blue-600 text-white rounded-2xl mb-4 shadow-lg shadow-blue-200">
            <i class="fa-solid fa-microchip text-2xl"></i>
        </div>
        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">백엔설 (Back-An-Swer)</h1>
        <p class="text-slate-500 mt-2 font-medium">백엔드 개발자 개념 완성 가이드</p>
    </header>

    <!-- Home Step -->
    <div id="step-home" class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200">
        <h2 class="text-xl font-bold mb-6 flex items-center gap-2 text-slate-800">
            <i class="fa-solid fa-book-open text-blue-600 text-lg"></i>
            학습 설정
        </h2>
        <div class="space-y-6">
            <div>
                <label class="block text-sm font-semibold text-slate-700 mb-2">학습 주제</label>
                <input type="text" id="input-topic" placeholder="예: 데이터베이스 인덱스 구조, Redis 캐싱 전략"
                       class="w-full p-4 bg-slate-100 rounded-xl border-none focus:ring-2 focus:ring-blue-500 outline-none transition-all">
                <div id="error-msg" class="mt-3 hidden items-center gap-2 text-red-500 text-sm font-medium bg-red-50 p-3 rounded-lg border border-red-100">
                    <i class="fa-solid fa-circle-exclamation"></i>
                    <span id="error-text"></span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">난이도</label>
                    <div class="flex gap-2 p-1 bg-slate-100 rounded-xl" id="difficulty-tabs">
                        <button data-val="하" class="flex-1 py-3 rounded-lg font-bold transition-all text-slate-500">하</button>
                        <button data-val="중" class="flex-1 py-3 rounded-lg font-bold transition-all bg-white text-blue-600 shadow-sm">중</button>
                        <button data-val="상" class="flex-1 py-3 rounded-lg font-bold transition-all text-slate-500">상</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-slate-700 mb-2">문제 수</label>
                    <select id="select-count" class="w-full p-4 bg-slate-100 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 appearance-none font-bold text-slate-700">
                        <option value="3">3문제</option>
                        <option value="5" selected>5문제</option>
                        <option value="10">10문제</option>
                    </select>
                </div>
            </div>

            <button id="btn-start" class="w-full py-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-2xl transition-all shadow-lg shadow-blue-100 flex items-center justify-center gap-2">
                학습 시작하기 <i class="fa-solid fa-bolt"></i>
            </button>
        </div>
    </div>

    <!-- Loading Step -->
    <div id="step-loading" class="bg-white rounded-3xl p-12 shadow-sm border border-slate-200 text-center hidden-step">
        <i class="fa-solid fa-spinner animate-spin text-4xl text-blue-600 mb-6"></i>
        <h2 class="text-xl font-bold text-slate-800 mb-2">AI가 문제를 생성 중입니다</h2>
        <p id="loading-msg" class="text-slate-500">잠시만 기다려주세요. 모든 문제를 한 번에 준비하고 있습니다...</p>
    </div>

    <!-- Quiz Step -->
    <div id="step-quiz" class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200 relative hidden-step">
        <div class="flex justify-between items-center mb-8">
            <div class="flex flex-col">
                <span id="quiz-num-label" class="px-3 py-1 bg-blue-50 text-blue-600 rounded-lg text-[10px] font-bold uppercase tracking-wider mb-1 w-fit">Q 1</span>
            </div>
            <div class="w-1/3 h-1.5 bg-slate-100 rounded-full overflow-hidden">
                <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-500" style="width: 20%"></div>
            </div>
        </div>

        <h2 id="quiz-question" class="text-xl font-bold text-slate-800 mb-8 leading-relaxed"></h2>

        <div id="quiz-options" class="space-y-3"></div>

        <div id="quiz-feedback" class="mt-8 hidden fade-in">
            <div id="feedback-box" class="p-5 rounded-2xl mb-6 flex gap-4 border">
                <i class="fa-solid fa-circle-info shrink-0 mt-1"></i>
                <div>
                    <p id="feedback-title" class="font-bold mb-1"></p>
                    <p id="feedback-explanation" class="text-sm leading-relaxed opacity-90"></p>
                </div>
            </div>
            <button id="btn-next" class="w-full py-4 bg-slate-900 text-white font-bold rounded-2xl hover:bg-black transition-all flex items-center justify-center gap-2">
                <span id="next-btn-text">다음 문제</span> <i class="fa-solid fa-chevron-right"></i>
            </button>
        </div>
    </div>

    <!-- Result Step -->
    <div id="step-result" class="bg-white rounded-3xl p-10 shadow-sm border border-slate-200 text-center hidden-step">
        <i class="fa-solid fa-trophy text-6xl text-amber-400 mb-6"></i>
        <h2 class="text-3xl font-bold mb-2 tracking-tight">학습 완료!</h2>
        <div class="text-6xl font-black text-blue-600 my-8">
            <span id="correct-count">0</span> <span class="text-2xl text-slate-300 font-normal">/ <span id="total-count">0</span></span>
        </div>
        <p class="text-slate-500 mb-10 max-w-sm mx-auto font-medium">학습하신 내용을 바탕으로 백엔드 실력을 더욱 탄탄하게 다져보세요.</p>
        <div class="flex flex-col gap-4">
            <button id="btn-reset" class="w-full py-4 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold rounded-2xl transition-all flex items-center justify-center gap-2">
                <i class="fa-solid fa-rotate-left"></i> 다른 주제 시작하기
            </button>
        </div>
    </div>
</div>

<script>
    const apiKey = "";

    let state = {
        topic: '',
        difficulty: '중',
        quizCount: 5,
        quizzes: [],
        currentIdx: 0,
        userAnswers: []
    };

    const elements = {
        steps: ['home', 'loading', 'quiz', 'result'].reduce((acc, s) => {
            acc[s] = document.getElementById(`step-${s}`);
            return acc;
        }, {}),
        inputTopic: document.getElementById('input-topic'),
        errorMsg: document.getElementById('error-msg'),
        errorText: document.getElementById('error-text'),
        loadingMsg: document.getElementById('loading-msg'),
        difficultyBtns: document.querySelectorAll('#difficulty-tabs button'),
        selectCount: document.getElementById('select-count'),
        btnStart: document.getElementById('btn-start'),
        btnReset: document.getElementById('btn-reset'),
        quizQuestion: document.getElementById('quiz-question'),
        quizOptions: document.getElementById('quiz-options'),
        quizFeedback: document.getElementById('quiz-feedback'),
        feedbackBox: document.getElementById('feedback-box'),
        feedbackTitle: document.getElementById('feedback-title'),
        feedbackExp: document.getElementById('feedback-explanation'),
        btnNext: document.getElementById('btn-next'),
        nextBtnText: document.getElementById('next-btn-text'),
        progressBar: document.getElementById('progress-bar'),
        quizNumLabel: document.getElementById('quiz-num-label'),
        correctCount: document.getElementById('correct-count'),
        totalCount: document.getElementById('total-count')
    };

    const showStep = (stepName) => {
        Object.values(elements.steps).forEach(s => s.classList.add('hidden-step'));
        elements.steps[stepName].classList.remove('hidden-step');
    };

    const callGemini = async (prompt, systemInstruction) => {
        let delay = 1000;
        for (let i = 0; i < 5; i++) {
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: systemInstruction }] },
                        generationConfig: { responseMimeType: "application/json" }
                    })
                });
                if (!response.ok) throw new Error();
                const data = await response.json();
                return JSON.parse(data.candidates[0].content.parts[0].text);
            } catch (e) {
                if (i === 4) throw e;
                await new Promise(r => setTimeout(r, delay));
                delay *= 2;
            }
        }
    };

    elements.difficultyBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            elements.difficultyBtns.forEach(b => {
                b.className = "flex-1 py-3 rounded-lg font-bold transition-all text-slate-500";
            });
            btn.className = "flex-1 py-3 rounded-lg font-bold transition-all bg-white text-blue-600 shadow-sm";
            state.difficulty = btn.dataset.val;
        });
    });

    elements.btnStart.addEventListener('click', async () => {
        state.topic = elements.inputTopic.value.trim();
        state.quizCount = parseInt(elements.selectCount.value);

        if (!state.topic) {
            elements.errorMsg.classList.remove('hidden');
            elements.errorText.innerText = "학습 주제를 입력해주세요.";
            return;
        }

        elements.errorMsg.classList.add('hidden');
        elements.loadingMsg.innerText = "모든 문제를 생성 중입니다. 잠시만 기다려주세요...";
        showStep('loading');

        try {
            const diffMap = { '상': 'Senior', '중': 'Intermediate', '하': 'Junior' };
            const systemPrompt = `You are a Backend Interviewer.
                1. Validate if topic "${state.topic}" is related to Backend Engineering.
                2. If invalid, return { "valid": false, "reason": "Explain why in Korean" }.
                3. If valid, return { "valid": true, "quizzes": [{ "question": "...", "options": ["...", "..."], "answer": "The EXACT string from one of options", "explanation": "..." }] }.
                Generate exactly ${state.quizCount} unique quizzes.
                Difficulty: ${diffMap[state.difficulty]}. Language: Korean.`;

            const result = await callGemini(`Topic: ${state.topic}`, systemPrompt);

            if (!result.valid) {
                elements.errorMsg.classList.remove('hidden');
                elements.errorText.innerText = result.reason;
                showStep('home');
                return;
            }

            state.quizzes = result.quizzes;
            state.currentIdx = 0;
            state.userAnswers = [];
            renderQuiz();
            showStep('quiz');
        } catch (e) {
            elements.errorMsg.classList.remove('hidden');
            elements.errorText.innerText = "오류가 발생했습니다. 다시 시도해주세요.";
            showStep('home');
        }
    });

    const renderQuiz = () => {
        const q = state.quizzes[state.currentIdx];
        elements.quizQuestion.innerText = q.question;
        elements.quizOptions.innerHTML = '';
        elements.quizFeedback.classList.add('hidden');

        elements.quizNumLabel.innerText = `Q ${state.currentIdx + 1}`;
        elements.progressBar.style.width = `${((state.currentIdx + 1) / state.quizCount) * 100}%`;

        q.options.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = "w-full p-5 text-left border-2 bg-slate-50 border-transparent rounded-2xl transition-all flex items-center justify-between group hover:bg-slate-100";
            // 텍스트만 담기 위해 span 사용
            btn.innerHTML = `<span class="opt-text">${opt}</span><span class="icon-placeholder"></span>`;
            btn.onclick = () => handleAnswer(opt, btn);
            elements.quizOptions.appendChild(btn);
        });
    };

    const handleAnswer = (selected, btn) => {
        const q = state.quizzes[state.currentIdx];

        // 정확한 비교를 위해 trim() 처리
        const cleanSelected = selected.toString().trim();
        const cleanAnswer = q.answer.toString().trim();

        const isCorrect = cleanAnswer === cleanSelected;
        state.userAnswers.push({ correct: isCorrect });

        Array.from(elements.quizOptions.children).forEach(child => {
            child.disabled = true;
            const optText = child.querySelector('.opt-text').innerText.trim();

            if (optText === cleanAnswer) {
                // 정답 버튼 표시
                child.className = "w-full p-5 text-left border-2 bg-green-100 border-green-500 text-green-700 font-bold rounded-2xl flex items-center justify-between";
                child.querySelector('.icon-placeholder').innerHTML = `<i class="fa-solid fa-circle-check"></i>`;
            } else if (optText === cleanSelected && !isCorrect) {
                // 오답인 경우 내가 선택한 것 표시
                child.className = "w-full p-5 text-left border-2 bg-red-100 border-red-500 text-red-700 rounded-2xl flex items-center justify-between";
                child.querySelector('.icon-placeholder').innerHTML = `<i class="fa-solid fa-circle-xmark"></i>`;
            } else {
                // 나머지 버튼 흐리게
                child.className = "w-full p-5 text-left border-2 bg-slate-50 border-transparent text-slate-400 opacity-50 rounded-2xl flex items-center justify-between";
            }
        });

        elements.feedbackBox.className = `p-5 rounded-2xl mb-6 flex gap-4 border ${isCorrect ? 'bg-green-50 text-green-800 border-green-100' : 'bg-red-50 text-red-800 border-red-100'}`;
        elements.feedbackTitle.innerText = isCorrect ? "정답입니다!" : "오답입니다";
        elements.feedbackExp.innerText = q.explanation;

        elements.nextBtnText.innerText = (state.currentIdx < state.quizCount - 1) ? "다음 문제" : "결과 보기";
        elements.quizFeedback.classList.remove('hidden');
    };

    elements.btnNext.addEventListener('click', () => {
        if (state.currentIdx < state.quizzes.length - 1) {
            state.currentIdx++;
            renderQuiz();
        } else {
            showResult();
        }
    });

    const showResult = () => {
        elements.correctCount.innerText = state.userAnswers.filter(a => a.correct).length;
        elements.totalCount.innerText = state.quizCount;
        showStep('result');
    };

    elements.btnReset.addEventListener('click', () => {
        elements.inputTopic.value = '';
        showStep('home');
    });
</script>
</body>
</html>