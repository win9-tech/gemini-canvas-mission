<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„¤íŠ¸ì›Œì½” - ìš°í…Œì½” í¬ë£¨ ë§¤ì¹­</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #F8FAFC; }
        .woowa-green { color: #2AC1BC; }
        .woowa-bg { background-color: #2AC1BC; }

        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #2AC1BC; border-radius: 10px; }
        .hidden { display: none !important; }

        .skeleton {
            background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
        }
        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .option-card { transition: all 0.15s ease; cursor: pointer; }
        .option-card.selected {
            background-color: #F0FDFA;
            border-color: #2AC1BC;
            color: #2AC1BC;
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(42, 193, 188, 0.1);
        }

        .my-team-card {
            background: #2AC1BC;
            color: white;
            box-shadow: 0 15px 30px -5px rgba(42, 193, 188, 0.4);
        }

        .bottom-nav {
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Logo Animation */
        .logo-pulse {
            animation: logo-pulse 2s infinite ease-in-out;
        }
        @keyframes logo-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
        }
    </style>
</head>
<body class="min-h-screen text-slate-900 p-4 md:p-8 pb-28">
<div class="max-w-md mx-auto">
    <!-- Header & Logo -->
    <header class="mb-6 text-center">
        <div class="inline-block relative mb-2">
            <div class="absolute inset-0 woowa-bg blur-2xl opacity-20 rounded-full logo-pulse"></div>
            <div class="relative inline-flex items-center justify-center p-4 woowa-bg text-white rounded-[2rem] shadow-2xl shadow-teal-100 transition-transform active:scale-95">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="18" cy="5" r="3"></circle>
                    <circle cx="6" cy="12" r="3"></circle>
                    <circle cx="18" cy="19" r="3"></circle>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
                </svg>
            </div>
        </div>
        <h1 class="text-4xl font-black text-slate-800 tracking-tighter">ë„¤íŠ¸ì›Œì½”</h1>
        <p class="text-xs font-bold text-slate-400 uppercase tracking-[0.2em] mb-3">Connecting Crews</p>
        <p id="display-week" class="px-4 py-1.5 bg-slate-200 text-slate-700 rounded-full font-bold text-[10px] uppercase tracking-tight inline-block">
            ë‚ ì§œ ê³„ì‚° ì¤‘...
        </p>
    </header>

    <!-- Error Message Bar -->
    <div id="error-bar" class="hidden mb-4 p-4 bg-red-50 border border-red-100 text-red-600 rounded-2xl flex items-center justify-between gap-3 text-sm animate-fade-in shadow-sm">
        <div class="flex items-center gap-3">
            <i data-lucide="alert-circle" size="18"></i>
            <p id="error-text" class="font-bold"></p>
        </div>
        <button onclick="location.reload()" class="p-2 hover:bg-red-100 rounded-full transition-colors">
            <i data-lucide="refresh-ccw" size="14"></i>
        </button>
    </div>

    <main id="main-card" class="bg-white rounded-[2.5rem] shadow-2xl shadow-teal-100/50 border border-slate-100 overflow-hidden min-h-[580px] relative">
        <!-- VIEW: Loading -->
        <div id="view-loading" class="flex h-[580px] items-center justify-center">
            <i data-lucide="loader-2" class="animate-spin text-[#2AC1BC]" size="48"></i>
        </div>

        <!-- VIEW: Profile Steps -->
        <div id="view-profile" class="hidden p-8 space-y-8 animate-fade-in">
            <div id="profile-progress" class="flex justify-between items-center px-1 h-1.5"></div>
            <div id="profile-step-container" class="min-h-[440px]"></div>
        </div>

        <!-- VIEW: Dashboard -->
        <div id="view-dashboard" class="hidden p-0 animate-fade-in text-left min-h-[580px] flex flex-col">
            <!-- User Profile Header -->
            <div class="p-8 bg-teal-50 border-b border-teal-100 flex justify-between items-center shadow-sm">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-white rounded-[1.2rem] flex items-center justify-center text-3xl shadow-xl border border-teal-50">ğŸ‘¤</div>
                    <div>
                        <h2 id="user-nickname" class="text-2xl font-black text-slate-800 tracking-tight">ì‚¬ìš©ìë‹˜</h2>
                        <p id="user-mbti" class="text-[10px] font-black text-[#2AC1BC] uppercase tracking-widest font-mono"></p>
                    </div>
                </div>
                <button id="btn-logout" class="p-3 bg-white rounded-2xl text-slate-400 hover:text-red-500 shadow-sm transition-all">
                    <i data-lucide="log-out" size="22"></i>
                </button>
            </div>

            <!-- Global Matching Overlay -->
            <div id="global-matching-overlay" class="hidden fixed inset-0 z-[100] bg-white/95 flex flex-col items-center justify-center p-8 text-center animate-fade-in">
                <div class="relative mb-8">
                    <div class="absolute inset-0 woowa-bg opacity-20 blur-3xl rounded-full scale-150"></div>
                    <i data-lucide="sparkles" class="text-[#2AC1BC] animate-bounce relative" size="64"></i>
                </div>
                <h3 class="text-2xl font-black text-slate-800 tracking-tight mb-2">í¬ë£¨ì› ë§¤ì¹­ ì¤‘ì…ë‹ˆë‹¤...</h3>
                <p class="text-slate-500 font-medium leading-relaxed">ë„¤íŠ¸ì›Œì½” AIê°€ ì„±í–¥ì„ ë¶„ì„í•˜ì—¬<br>ìµœì ì˜ ì›”/ìˆ˜/ê¸ˆ íŒŒíŠ¸ë„ˆë¥¼ ì°¾ê³  ìˆì–´ìš”.</p>
            </div>

            <!-- Content Area -->
            <div class="flex-1 p-6 overflow-y-auto custom-scroll" id="dashboard-scroll-area">
                <!-- TAB 1: í¬ë£¨ ëª©ë¡ -->
                <div id="tab-content-list" class="space-y-6">
                    <div id="registration-prompt" class="hidden bg-white border-2 border-dashed border-slate-200 rounded-[2.5rem] p-10 text-center space-y-6 shadow-sm">
                        <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto text-slate-300"><i data-lucide="user-plus" size="40"></i></div>
                        <p class="text-sm text-slate-500 font-bold leading-relaxed">ì´ë²ˆ ì£¼ ë§¤ì¹­ ì°¸ì—¬ ëª…ë‹¨ì—<br>ë‚´ ì´ë¦„ì„ ì˜¬ë ¤ì£¼ì„¸ìš”.</p>
                        <button id="btn-join-pool" class="w-full py-5 woowa-bg text-white rounded-2xl font-black shadow-xl text-xl transition-all active:scale-95">ì§€ê¸ˆ ì°¸ì—¬í•˜ê¸°</button>
                    </div>

                    <!-- Wait Box -->
                    <div id="wait-box" class="hidden bg-teal-50/50 rounded-[2.5rem] p-10 border border-teal-100 text-center shadow-inner relative overflow-hidden mt-8 mb-4">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-white/20 blur-3xl"></div>
                        <div class="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto text-teal-500 mb-6 shadow-xl"><i data-lucide="users-2" size="44"></i></div>
                        <h3 class="font-black text-2xl text-slate-800 mb-3 tracking-tight">ë§¤ì¹­ ëŒ€ê¸° ì¤‘...</h3>
                        <p class="text-sm text-slate-500 mb-10 font-medium leading-relaxed text-center">í¬ë£¨ì›ë“¤ì´ ëª¨ë‘ ëª¨ì´ë©´<br>ì›”/ìˆ˜/ê¸ˆ ë§¤ì¹­ì´ ìƒì„±ë©ë‹ˆë‹¤.</p>
                        <button id="btn-run-match" class="w-full bg-slate-900 text-white font-black py-5.5 rounded-[1.8rem] shadow-2xl text-xl transition-all active:scale-95">ì „ì²´ ë¡œí…Œì´ì…˜ ë§¤ì¹­ ì‹¤í–‰</button>
                        <p id="ready-count" class="mt-4 text-[10px] text-teal-600 font-black uppercase tracking-widest font-mono">0 CREWS READY</p>
                    </div>

                    <div id="waiting-list-section" class="space-y-4">
                        <h3 class="text-xs font-black text-slate-400 px-1 uppercase tracking-[0.2em] flex items-center gap-2"><i data-lucide="users" size="14"></i> Waiting List</h3>
                        <div id="crews-grid" class="grid grid-cols-2 gap-3 pb-4"></div>
                    </div>
                </div>

                <!-- TAB 2: ë§¤ì¹­ ê²°ê³¼ -->
                <div id="tab-content-result" class="hidden space-y-6 animate-fade-in">
                    <div id="result-board" class="space-y-6">
                        <div id="day-tabs" class="flex bg-slate-100 p-1.5 rounded-[1.5rem] shadow-inner">
                            <button onclick="setActiveDay('ì›”ìš”ì¼')" id="tab-mon" class="flex-1 py-3.5 rounded-2xl text-sm font-black transition-all">ì›”ìš”ì¼</button>
                            <button onclick="setActiveDay('ìˆ˜ìš”ì¼')" id="tab-wed" class="flex-1 py-3.5 rounded-2xl text-sm font-black transition-all">ìˆ˜ìš”ì¼</button>
                            <button onclick="setActiveDay('ê¸ˆìš”ì¼')" id="tab-fri" class="flex-1 py-3.5 rounded-2xl text-sm font-black transition-all">ê¸ˆìš”ì¼</button>
                        </div>

                        <div id="match-cards-container" class="bg-gradient-to-br from-slate-900 to-slate-800 rounded-[3rem] p-8 text-white shadow-2xl relative overflow-hidden border border-white/5">
                            <div class="absolute top-0 right-0 w-40 h-40 bg-teal-500/10 blur-[80px]"></div>
                            <div class="flex justify-between items-center mb-10 relative z-10">
                                <h3 id="board-title" class="font-black text-xl italic tracking-tighter uppercase text-[#2AC1BC]">ë§¤ì¹­ ê²°ê³¼</h3>
                                <i data-lucide="sparkles" class="text-amber-400 animate-pulse" size="24"></i>
                            </div>
                            <div id="match-pairs-list" class="space-y-8 relative z-10"></div>
                            <div class="mt-10 pt-6 border-t border-white/10 text-center opacity-40">
                                <p class="text-[10px] font-black uppercase tracking-[0.2em]">Generated by Netwoo-co AI</p>
                            </div>
                        </div>
                        <button id="btn-re-match" class="w-full py-5 text-slate-400 text-[11px] font-black hover:text-[#2AC1BC] transition-all border-2 border-dashed border-slate-200 rounded-[1.5rem] uppercase tracking-widest">ì¼ì • ë‹¤ì‹œ ë§¤ì¹­í•˜ê¸°</button>
                    </div>
                    <div id="no-result-msg" class="hidden py-20 text-center space-y-4">
                        <i data-lucide="info" class="mx-auto text-slate-300" size="48"></i>
                        <p class="text-slate-400 font-bold">ì•„ì§ ì´ë²ˆ ì£¼ ë§¤ì¹­ ê²°ê³¼ê°€ ì—†ì–´ìš”.<br>í¬ë£¨ ëª©ë¡ íƒ­ì—ì„œ ë§¤ì¹­ì„ ì‹¤í–‰í•´ ì£¼ì„¸ìš”!</p>
                    </div>
                </div>
            </div>

            <!-- Bottom Tab Navigation -->
            <nav class="bottom-nav absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 flex h-20 px-6 z-50">
                <button onclick="switchDashboardTab('list')" id="nav-tab-list" class="flex-1 flex flex-col items-center justify-center gap-1 woowa-green transition-all">
                    <i data-lucide="layout-list" size="24"></i>
                    <span class="text-[11px] font-black uppercase tracking-tight">í¬ë£¨ ëª©ë¡</span>
                </button>
                <button onclick="switchDashboardTab('result')" id="nav-tab-result" class="flex-1 flex flex-col items-center justify-center gap-1 text-slate-300 transition-all relative">
                    <i data-lucide="trophy" size="24"></i>
                    <span class="text-[11px] font-black uppercase tracking-tight">ë§¤ì¹­ ê²°ê³¼</span>
                    <div id="new-result-badge" class="hidden absolute top-4 right-1/3 w-2 h-2 bg-red-500 rounded-full border-2 border-white"></div>
                </button>
            </nav>
        </div>
    </main>

    <footer class="mt-12 text-center pb-12 opacity-30">
        <p class="text-[9px] font-black text-slate-500 uppercase tracking-[0.4em]">Netwoo-co â€¢ Connecting Woowahan Crews</p>
    </footer>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = JSON.parse(__firebase_config);
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'netwoo-co-v15-real';
    const apiKey = "";

    let state = {
        user: null, view: 'loading', profileStep: 1, myData: null,
        weeklyCrews: [], globalMatchResult: null, isRegistering: false,
        activeDay: 'ì›”ìš”ì¼', activeTab: 'list', tendencyAnswers: [],
        formData: { nickname: '', mbti: '', intro: '', preference: 'similar' }
    };

    const MBTI_LIST = ['ISTJ', 'ISFJ', 'INFJ', 'INTJ', 'ISTP', 'ISFP', 'INFP', 'INTP', 'ESTP', 'ESFP', 'ENFP', 'ENTP', 'ESTJ', 'ESFJ', 'ENFJ', 'ENTJ'];
    const TENDENCY_QUESTIONS = [
        { id: 1, question: "ì–´ë–¤ ëŒ€í™”ë¥¼ ë” ì„ í˜¸í•˜ì‹œë‚˜ìš”?", options: ["ê¹Šì´ ìˆëŠ” ê¸°ìˆ  í† í¬ ğŸ’»", "í¸ì•ˆí•œ ì¼ìƒ ëŒ€í™” â˜•"] },
        { id: 2, question: "ë‚˜ì˜ ì†Œí†µ ìŠ¤íƒ€ì¼ì€?", options: ["ì°¨ë¶„í•˜ê²Œ ê²½ì²­í•˜ëŠ” í¸ ğŸ‘‚", "í™œë°œí•˜ê²Œ ì˜ê²¬ì„ ë‚´ëŠ” í¸ ğŸ—£ï¸"] },
        { id: 3, question: "ë¬¸ì œë¥¼ í•´ê²°í•  ë•Œ?", options: ["ë…¼ë¦¬ì™€ íŒ©íŠ¸ ì¤‘ì‹¬ ğŸ”", "ê³µê°ê³¼ ë°°ë ¤ ì¤‘ì‹¬ ğŸ«‚"] },
        { id: 4, question: "í•™ìŠµ ìŠ¤íƒ€ì¼ì€?", options: ["í•¨ê»˜í•˜ëŠ” í˜ì–´ í”„ë¡œê·¸ë˜ë° ğŸ¤", "í˜¼ì ê³ ë¯¼í•˜ëŠ” ë”¥ë‹¤ì´ë¸Œ ğŸ“‘"] },
        { id: 5, question: "í¬ë£¨ì™€ í•˜ê³  ì‹¶ì€ ê²ƒ?", options: ["í”„ë¡œì íŠ¸ì™€ ìŠ¤í„°ë”” ğŸ“–", "ë§›ì§‘ íƒë°©ê³¼ ì·¨ë¯¸ ê³µìœ  ğŸ•"] }
    ];

    const fetchWithRetry = async (url, options, retries = 3, delay = 1500) => {
        for (let i = 0; i < retries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                return await response.json();
            } catch (err) {
                if (i === retries - 1) throw err;
                await new Promise(r => setTimeout(r, delay));
                delay *= 1.5;
            }
        }
    };

    const getFormattedWeek = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        const date = now.getDate();
        const firstDayOfMonth = new Date(year, now.getMonth(), 1);
        const weekNo = Math.ceil((date + firstDayOfMonth.getDay()) / 7);
        return `${year}ë…„ ${month}ì›” ${weekNo}ì£¼ì°¨`;
    };

    const getWeekId = () => {
        const now = new Date();
        const startOfYear = new Date(now.getFullYear(), 0, 1);
        const pastDaysOfYear = (now - startOfYear) / 86400000;
        const weekNum = Math.ceil((pastDaysOfYear + startOfYear.getDay() + 1) / 7);
        return `${now.getFullYear()}-W${weekNum}`;
    };

    const weekId = getWeekId();
    const displayWeekEl = document.getElementById('display-week');
    if (displayWeekEl) displayWeekEl.innerText = getFormattedWeek();

    const updateView = (viewName) => {
        state.view = viewName;
        document.querySelectorAll('main > div').forEach(div => div.classList.add('hidden'));
        const target = document.getElementById(`view-${viewName}`);
        if (target) target.classList.remove('hidden');
        lucide.createIcons();
    };

    const showError = (msg) => {
        const bar = document.getElementById('error-bar');
        const text = document.getElementById('error-text');
        if (bar && text) {
            if (msg) { text.innerText = msg; bar.classList.remove('hidden'); }
            else { bar.classList.add('hidden'); }
        }
    };

    window.switchDashboardTab = (tabId) => {
        state.activeTab = tabId;
        const listContent = document.getElementById('tab-content-list');
        const resultContent = document.getElementById('tab-content-result');
        const navListBtn = document.getElementById('nav-tab-list');
        const navResultBtn = document.getElementById('nav-tab-result');
        const badge = document.getElementById('new-result-badge');

        if (listContent) listContent.classList.toggle('hidden', tabId !== 'list');
        if (resultContent) resultContent.classList.toggle('hidden', tabId !== 'result');

        if (navListBtn) {
            navListBtn.classList.toggle('woowa-green', tabId === 'list');
            navListBtn.classList.toggle('text-slate-300', tabId !== 'list');
        }
        if (navResultBtn) {
            navResultBtn.classList.toggle('woowa-green', tabId === 'result');
            navResultBtn.classList.toggle('text-slate-300', tabId !== 'result');
        }

        if (tabId === 'result') {
            if (badge) badge.classList.add('hidden');
            const hasData = !!state.globalMatchResult?.results;
            document.getElementById('result-board')?.classList.toggle('hidden', !hasData);
            document.getElementById('no-result-msg')?.classList.toggle('hidden', hasData);
            if (hasData) renderMatches();
        }
        lucide.createIcons();
    };

    window.nextStep = (step) => {
        const nicknameInput = document.getElementById('input-nickname');
        if (step === 2 && !nicknameInput?.value.trim()) return;
        if (step === 2) state.formData.nickname = nicknameInput.value.trim();
        state.profileStep = step;
        renderProfileSteps();
    };

    const renderProfileSteps = () => {
        const progress = document.getElementById('profile-progress');
        if (progress) {
            progress.innerHTML = [1, 2, 3, 4, 5, 6, 7].map(s =>
                `<div class="h-full flex-1 mx-0.5 rounded-full transition-all duration-300 ${state.profileStep >= s ? 'woowa-bg' : 'bg-slate-100'}"></div>`
            ).join('');
        }

        const container = document.getElementById('profile-step-container');
        if (!container) return;
        container.innerHTML = '';

        const wrap = document.createElement('div');
        wrap.className = "profile-step space-y-8 animate-fade-in";

        if (state.profileStep === 1) {
            wrap.innerHTML = `
                    <div class="text-center space-y-2">
                        <h2 class="text-2xl font-black text-slate-800 tracking-tight">ë„¤íŠ¸ì›Œì½”ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•´ìš”!</h2>
                        <p class="text-slate-400 text-sm font-medium">í¬ë£¨ì›ë“¤ì´ ë¶€ë¥¼ ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
                    </div>
                    <input id="input-nickname" type="text" class="w-full px-6 py-5 rounded-[1.8rem] border-4 border-slate-50 focus:border-[#2AC1BC] outline-none text-2xl font-black shadow-inner bg-slate-50 transition-all focus:bg-white" placeholder="ì˜ˆ: í¬ë¹„" value="${state.formData.nickname}">
                    <button onclick="nextStep(2)" class="w-full woowa-bg text-white font-black py-5 rounded-[1.5rem] shadow-xl text-xl flex items-center justify-center gap-2 transition-all active:scale-95">ë‹¤ìŒìœ¼ë¡œ <i data-lucide="arrow-right" size="20"></i></button>
                `;
        } else if (state.profileStep === 2) {
            wrap.innerHTML = `
                    <div class="space-y-6">
                        <div class="flex items-center gap-2">
                            <button onclick="nextStep(1)" class="p-2 text-slate-300 hover:text-slate-500 transition-colors"><i data-lucide="chevron-left"></i></button>
                            <div class="flex-1 text-center pr-8"><h2 class="text-2xl font-black text-slate-800 tracking-tight">MBTI ì„ íƒ</h2></div>
                        </div>
                        <div class="grid grid-cols-4 gap-2">
                            ${MBTI_LIST.map(m => `<button onclick="selectMBTI(this, '${m}')" class="mbti-btn py-4 rounded-2xl text-sm font-black border-2 transition-all ${state.formData.mbti === m ? 'woowa-bg border-[#2AC1BC] text-white shadow-lg scale-105' : 'bg-white border-slate-50 text-slate-400 hover:border-slate-200'}">${m}</button>`).join('')}
                        </div>
                    </div>
                `;
        } else {
            const qIdx = state.profileStep - 3;
            const q = TENDENCY_QUESTIONS[qIdx];
            wrap.innerHTML = `
                    <div class="space-y-8">
                        <div class="flex items-center gap-2">
                            <button onclick="nextStep(${state.profileStep - 1})" class="p-2 text-slate-300 hover:text-slate-500 transition-colors"><i data-lucide="chevron-left"></i></button>
                            <div class="flex-1 text-center pr-8">
                                <span class="text-[10px] font-black woowa-green uppercase tracking-widest bg-teal-50 px-3 py-1 rounded-full font-mono shadow-sm">Question ${q.id}/5</span>
                                <h2 class="text-2xl font-black text-slate-800 mt-4 break-keep tracking-tight">${q.question}</h2>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4">
                            ${q.options.map(opt => `<button onclick="selectTendency(this, '${opt}', ${qIdx})" class="option-card px-6 py-6 rounded-[2.2rem] text-lg font-bold text-left border-4 flex items-center justify-between bg-white border-slate-50 text-slate-500 hover:bg-slate-50 ${state.tendencyAnswers[qIdx] === opt ? 'selected' : ''}"><span>${opt}</span>${state.tendencyAnswers[qIdx] === opt ? '<i data-lucide="check" size="24"></i>' : ''}</button>`).join('')}
                        </div>
                        ${q.id === 5 ? `<button onclick="handleProfileDone()" id="btn-save-prof" class="w-full woowa-bg text-white font-black py-5 rounded-[1.8rem] shadow-xl text-xl mt-4 active:scale-95 transition-all">ë„¤íŠ¸ì›Œì½” ì‹œì‘í•˜ê¸°</button>` : ''}
                    </div>
                `;
        }
        container.appendChild(wrap);
        lucide.createIcons();
        const input = document.getElementById('input-nickname');
        if (input) {
            input.focus();
            input.onkeypress = (e) => { if (e.key === 'Enter') nextStep(2); };
        }
    };

    window.selectMBTI = (btn, m) => {
        document.querySelectorAll('.mbti-btn').forEach(b => b.classList.remove('woowa-bg', 'text-white', 'scale-105', 'shadow-lg'));
        btn.classList.add('woowa-bg', 'text-white', 'scale-105', 'shadow-lg');
        state.formData.mbti = m;
        setTimeout(() => nextStep(3), 150);
    };

    window.selectTendency = (btn, ans, idx) => {
        btn.parentElement.querySelectorAll('.option-card').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        state.tendencyAnswers[idx] = ans;
        if (idx < 4) setTimeout(() => nextStep(state.profileStep + 1), 200);
    };

    window.handleProfileDone = async () => {
        state.formData.intro = state.tendencyAnswers.join(" / ");
        await saveProfile();
    };

    const saveProfile = async () => {
        try {
            const profileRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'main');
            const payload = { ...state.formData, uid: state.user.uid, updatedAt: serverTimestamp() };
            await setDoc(profileRef, payload);
            state.myData = payload;
            updateView('dashboard');
            renderDashboard();
        } catch (e) { showError("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
    };

    const renderDashboard = () => {
        if (!state.myData) return;
        const nickEl = document.getElementById('user-nickname');
        const mbtiEl = document.getElementById('user-mbti');
        if (nickEl) nickEl.innerText = state.myData.nickname;
        if (mbtiEl) mbtiEl.innerText = state.myData.mbti;
        const isReg = state.weeklyCrews.some(c => c.nickname === state.myData.nickname);
        document.getElementById('registration-prompt')?.classList.toggle('hidden', isReg);
        document.getElementById('matching-area')?.classList.toggle('hidden', !isReg);
        if (isReg) {
            const matchStatus = state.globalMatchResult?.status;
            const isGlobalMatching = matchStatus === 'matching';
            document.getElementById('global-matching-overlay')?.classList.toggle('hidden', !isGlobalMatching);
            const hasResults = !!state.globalMatchResult?.results;
            document.getElementById('wait-box')?.classList.toggle('hidden', isGlobalMatching || hasResults);
            const readyCountEl = document.getElementById('ready-count');
            if (readyCountEl) readyCountEl.innerText = `${state.weeklyCrews.length} CREWS READY`;
            renderCrewsGrid();
            if (state.activeTab === 'result') renderMatches();
        }
        lucide.createIcons();
    };

    const renderCrewsGrid = () => {
        const grid = document.getElementById('crews-grid');
        if (!grid) return;
        grid.innerHTML = state.weeklyCrews.map(c => `
                <div class="p-4 rounded-[1.5rem] border-2 transition-all flex flex-col gap-1.5 shadow-sm ${c.nickname === state.myData.nickname ? 'border-[#2AC1BC] bg-teal-50 font-bold' : 'border-slate-50 bg-white'}">
                    <span class="font-black text-slate-800 truncate text-sm tracking-tight">${c.nickname}</span>
                    <span class="text-[10px] font-black woowa-green opacity-80 uppercase font-mono font-bold">${c.mbti}</span>
                </div>
            `).join('');
    };

    window.setActiveDay = (day) => { state.activeDay = day; renderMatches(); };

    const renderMatches = () => {
        const dayTabs = ['ì›”ìš”ì¼', 'ìˆ˜ìš”ì¼', 'ê¸ˆìš”ì¼'];
        dayTabs.forEach(d => {
            const tabId = d === 'ì›”ìš”ì¼' ? 'mon' : d === 'ìˆ˜ìš”ì¼' ? 'wed' : 'fri';
            const btn = document.getElementById(`tab-${tabId}`);
            if (btn) btn.className = `flex-1 py-3.5 rounded-2xl text-sm font-black transition-all ${state.activeDay === d ? 'woowa-bg text-white shadow-lg' : 'text-slate-400 hover:text-slate-600'}`;
        });
        const titleEl = document.getElementById('board-title');
        if (titleEl) titleEl.innerText = `${state.activeDay} ë§¤ì¹­ ê²°ê³¼`;
        if (!state.globalMatchResult?.results) return;
        const results = state.globalMatchResult.results;
        const dayKey = state.activeDay === 'ì›”ìš”ì¼' ? 'mon' : state.activeDay === 'ìˆ˜ìš”ì¼' ? 'wed' : 'fri';
        const pairs = results[dayKey] || [];
        const sortedPairs = [...pairs].sort((a, b) => b.members.includes(state.myData.nickname) - a.members.includes(state.myData.nickname));
        const list = document.getElementById('match-pairs-list');
        if (list) {
            list.innerHTML = sortedPairs.map(p => {
                const isMine = p.members.includes(state.myData.nickname);
                return `
                        <div class="rounded-[2.5rem] border-2 overflow-hidden transition-all duration-300 ${isMine ? 'my-team-card border-[#2AC1BC] scale-105 shadow-2xl' : 'bg-white/5 border-white/10 opacity-90'}">
                            <div class="p-8 text-center">
                                <div class="flex items-center justify-center gap-5 font-black text-3xl mb-4 tracking-tighter">
                                    ${p.members.map((m, i) => `<span>${m}</span>${i < p.members.length - 1 ? `<i data-lucide="heart" fill="currentColor" class="${isMine ? 'text-white scale-125 animate-pulse' : 'woowa-green text-white/20'}"></i>` : ''}`).join('')}
                                </div>
                                <p class="text-base font-bold leading-snug px-2 break-keep whitespace-pre-line ${isMine ? 'text-white' : 'text-slate-300 opacity-90'}">${p.reason}</p>
                            </div>
                            <div class="px-8 py-5 flex flex-col gap-3 ${isMine ? 'bg-black/10' : 'bg-white/5'}">
                                <div class="flex items-center gap-2">
                                    <i data-lucide="message-square" size="16" class="${isMine ? 'text-white' : 'text-teal-400'}"></i>
                                    <span class="text-[11px] font-black uppercase tracking-[0.15em] opacity-70 font-mono">AI Topic Mission</span>
                                </div>
                                <p class="text-sm font-bold leading-relaxed italic opacity-90 text-center">"${p.topic}"</p>
                            </div>
                        </div>
                    `;
            }).join('');
        }
        lucide.createIcons();
    };

    const registerForWeek = async () => {
        state.isRegistering = true;
        try {
            const docId = `${weekId}_${state.user.uid}`;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'registrations', docId), {
                ...state.myData, registeredAt: serverTimestamp(), weekId: weekId
            });
        } catch (e) { showError("ë“±ë¡ ì‹¤íŒ¨. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ì„¸ìš”."); }
        state.isRegistering = false;
    };

    const runBatchMatching = async () => {
        if (state.weeklyCrews.length < 2) { showError("ì°¸ì—¬ ì¸ì›ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."); return; }
        const globalMatchRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_matches', weekId);
        try {
            await setDoc(globalMatchRef, { status: 'matching' }, { merge: true });
            showError("");
            const systemPrompt = `ë„¤íŠ¸ì›Œì½”(Netwoo-co) ë§¤ì¹­ ë§ˆìŠ¤í„°. ì°¸ì—¬ ì¸ì› ì „ì›ì˜ ì›”/ìˆ˜/ê¸ˆ ë§¤ì¹­ ë¦¬ìŠ¤íŠ¸ ìƒì„±.
                [ì§€ì¹¨]
                1. ì°¸ì—¬ìê°€ í™€ìˆ˜ë©´ ë°˜ë“œì‹œ í•œ íŒ€ë§Œ 3ì¸ìœ¼ë¡œ êµ¬ì„±.
                2. ì›”/ìˆ˜/ê¸ˆ 3ì¼ ë™ì•ˆ ì¤‘ë³µì„ ìµœì†Œí™”í•˜ì—¬ ì¸ì›ì„ ë°°ì¹˜.
                3. ì¶”ì²œ ì‚¬ìœ (reason)ëŠ” ìœ„íŠ¸ ìˆê²Œ ë”± 2ì¤„ë¡œë§Œ ì‘ì„±.
                4. ì‘ë‹µì€ ìˆœìˆ˜ JSON í˜•ì‹ìœ¼ë¡œ, í‚¤ëŠ” ë°˜ë“œì‹œ "mon", "wed", "fri"ë¥¼ ì‚¬ìš©.
                5. ê° ë°°ì—´ ìš”ì†ŒëŠ” {"members": ["ì´ë¦„1","ì´ë¦„2"], "reason": "ë§¤ì¹­ ì‚¬ìœ ", "topic": "ì¶”ì²œ ëŒ€í™” ì£¼ì œ"} í˜•ì‹.`;
            const userQuery = `í¬ë£¨ëª…ë‹¨:\n${state.weeklyCrews.map(c => `- ${c.nickname}(${c.mbti}, ${c.intro})`).join('\n')}`;
            const result = await fetchWithRetry(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
            const matchData = JSON.parse(rawText.replace(/```json|```/g, "").trim());
            await setDoc(globalMatchRef, { results: matchData, status: 'completed', createdAt: serverTimestamp(), executedBy: state.myData.nickname });
        } catch (e) {
            await setDoc(globalMatchRef, { status: 'idle' }, { merge: true });
            showError("AI ì‘ë‹µ ì§€ì—°ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë§¤ì¹­ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        }
    };

    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) await signInWithCustomToken(auth, __initial_auth_token);
            else await signInAnonymously(auth);
        } catch (e) { showError("ë¡œê·¸ì¸ ì„¸ì…˜ ì˜¤ë¥˜"); }
    };

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            state.user = u;
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'main'));
                if (snap.exists()) {
                    state.myData = snap.data(); state.formData = { ...state.formData, ...snap.data() };
                    updateView('dashboard'); renderDashboard();
                } else { updateView('profile'); renderProfileSteps(); }
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'registrations'), (snap) => {
                    state.weeklyCrews = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(c => c.weekId === weekId);
                    if (state.view === 'dashboard') renderDashboard();
                });
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global_matches', weekId), (snap) => {
                    const oldStatus = state.globalMatchResult?.status;
                    state.globalMatchResult = snap.exists() ? snap.data() : null;
                    const newStatus = state.globalMatchResult?.status;
                    if (oldStatus === 'matching' && newStatus === 'completed') switchDashboardTab('result');
                    else if (newStatus === 'completed' && state.activeTab === 'list' && !oldStatus) document.getElementById('new-result-badge')?.classList.remove('hidden');
                    if (state.view === 'dashboard') renderDashboard();
                });
            } catch (e) { console.error("Load Error:", e); }
        }
    });

    initAuth();
    document.getElementById('btn-logout').onclick = () => signOut(auth).then(() => location.reload());
    document.getElementById('btn-join-pool').onclick = registerForWeek;
    document.getElementById('btn-run-match').onclick = runBatchMatching;
    document.getElementById('btn-re-match').onclick = runBatchMatching;
</script>
</body>
</html>
