<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>찔까 말까 - 우테코 크루용</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700;900&display=swap');

        body {
            font-family: 'Pretendard', sans-serif;
            background-color: #f8fafc;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .loader-spin {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .bounce-custom {
            animation: bounce 1s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(0); }
        }
    </style>
</head>
<body class="pb-12 text-slate-900">

<!-- Header -->
<header class="p-6 border-b bg-white sticky top-0 z-10 flex justify-between items-center shadow-sm">
    <div class="flex items-center gap-2">
        <div class="bg-gradient-to-br from-yellow-400 to-orange-500 p-2 rounded-xl shadow-inner">
            <i class="fas fa-utensils text-white text-xl"></i>
        </div>
        <h1 class="text-2xl font-black text-slate-800 tracking-tight">찔까 말까</h1>
    </div>
    <div class="text-[10px] font-black px-2 py-1 bg-slate-900 text-white rounded-full uppercase tracking-tighter">
        WOOWA v3.8
    </div>
</header>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-black/75 backdrop-blur-xl z-50 hidden flex-col items-center justify-center text-white px-8 text-center">
    <div class="relative mb-8 flex items-center justify-center">
        <i class="fas fa-circle-notch text-7xl text-yellow-400 opacity-80 loader-spin"></i>
        <div class="absolute inset-0 flex items-center justify-center translate-y-1">
            <i class="fas fa-utensils text-3xl text-white bounce-custom"></i>
        </div>
    </div>
    <h2 id="loadingTitle" class="text-2xl font-black mb-3 italic tracking-tight">처리 중...</h2>
    <p id="loadingDesc" class="text-base font-medium opacity-90 leading-relaxed max-w-[280px]">잠시만 기다려 주세요.</p>
</div>

<!-- Main Content -->
<main class="max-w-md mx-auto p-6" id="inputSection">
    <!-- 1. Goal Selection -->
    <section class="mb-8">
        <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4">목표 설정</h2>
        <div class="grid grid-cols-2 gap-4">
            <button onclick="setGoal('diet')" id="goalDiet" class="flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-200 bg-white text-slate-400 transition-all">
                <i class="fas fa-fire text-4xl mb-2"></i>
                <span class="font-black text-lg">다이어트</span>
            </button>
            <button onclick="setGoal('bulk')" id="goalBulk" class="flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-200 bg-white text-slate-400 transition-all">
                <i class="fas fa-dumbbell text-4xl mb-2"></i>
                <span class="font-black text-lg">증량</span>
            </button>
        </div>
    </section>

    <!-- 2. Image Upload & Validation -->
    <section class="mb-8">
        <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
            식단표 자동 등록 <span class="bg-yellow-400 text-white px-2 py-0.5 rounded-full text-[10px]">AI 검증</span>
        </h2>
        <div id="dropZone" class="relative rounded-3xl border-4 border-dashed border-slate-200 bg-slate-100 p-8 flex flex-col items-center justify-center hover:bg-slate-200 transition-all overflow-hidden">
            <div id="uploadPrompt" class="flex flex-col items-center">
                <div class="w-16 h-16 bg-white rounded-2xl shadow-sm flex items-center justify-center mb-4">
                    <i class="fas fa-cloud-upload-alt text-3xl text-yellow-500"></i>
                </div>
                <p class="font-black text-slate-800 mb-1 text-center">식단표 사진 올리기</p>
                <p class="text-[11px] text-slate-400 font-bold text-center leading-relaxed">식단표 또는 음식 사진만 등록 가능합니다.</p>
            </div>
            <div id="imagePreview" class="hidden relative w-full aspect-video rounded-2xl overflow-hidden shadow-md z-20">
                <img id="previewImg" class="w-full h-full object-cover">
                <button onclick="event.stopPropagation(); clearImage();" class="absolute top-3 right-3 bg-black/50 text-white p-2 w-10 h-10 rounded-full backdrop-blur-md flex items-center justify-center hover:bg-black transition-colors">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10">
        </div>
    </section>

    <!-- 3. Meal List Management -->
    <section class="mb-10">
        <div class="flex justify-between items-center mb-4 px-1">
            <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest">입력된 식단 리스트</h2>
            <button onclick="addMealField('')" class="px-3 py-1 bg-slate-800 text-white rounded-full text-[11px] font-black flex items-center gap-1 hover:bg-black">
                <i class="fas fa-plus"></i> 직접 추가
            </button>
        </div>
        <div id="mealList" class="space-y-3">
            <!-- Meal items injected here -->
        </div>
    </section>

    <!-- Error Guidance -->
    <div id="errorMessage" class="hidden mb-6 p-5 bg-red-50 text-red-600 rounded-3xl text-sm font-bold flex flex-col gap-2 border border-red-100">
        <div class="flex items-center gap-3">
            <i class="fas fa-exclamation-circle"></i>
            <span id="errorText"></span>
        </div>
    </div>

    <!-- 4. Trigger Result -->
    <button onclick="analyzeDiet()" class="w-full py-6 bg-slate-900 text-white rounded-[2rem] font-black text-2xl shadow-2xl hover:bg-black active:scale-[0.98] transition-all flex items-center justify-center gap-4 group">
        <span>분석 결과 확인</span>
        <i class="fas fa-wand-magic-sparkles text-yellow-400 group-hover:rotate-12 transition-transform"></i>
    </button>
</main>

<!-- Result Section -->
<main class="max-w-md mx-auto p-6 hidden animate-fade-in" id="resultSection">
    <button onclick="goBack()" class="flex items-center gap-1 text-slate-500 mb-8 font-bold hover:text-slate-800">
        <i class="fas fa-chevron-left"></i> 다시 입력하기
    </button>

    <div class="space-y-8">
        <section class="bg-white rounded-[2.5rem] p-10 shadow-2xl border-4 border-yellow-400 relative overflow-hidden text-center">
            <div class="absolute top-0 right-1/2 translate-x-1/2 -translate-y-1/2 p-4 bg-yellow-400 text-white rounded-full shadow-lg border-4 border-white">
                <i class="fas fa-medal text-2xl"></i>
            </div>
            <div class="mt-4">
                <h3 class="font-black text-yellow-600 text-xs uppercase mb-6 tracking-[0.2em]">크루님을 위한 최고의 메뉴</h3>
                <p id="resBestMeal" class="text-4xl font-black text-slate-900 mb-6 leading-tight tracking-tighter">분석 중...</p>
                <div class="h-1.5 w-12 bg-yellow-100 rounded-full mx-auto mb-6"></div>
                <p id="resBestReason" class="text-slate-500 text-lg font-bold leading-relaxed px-2 italic">"이유를 찾는 중입니다."</p>
            </div>
        </section>

        <section class="bg-slate-900 rounded-[2.5rem] p-10 shadow-xl text-white">
            <h3 class="font-black text-slate-500 text-xs uppercase mb-8 tracking-widest flex items-center justify-center gap-2">
                <i class="fas fa-lightbulb text-yellow-400"></i> 현실적인 실천 가이드
            </h3>
            <ul id="resTips" class="space-y-6"></ul>
        </section>
    </div>
</main>

<footer class="mt-10 text-center text-slate-300 text-[11px] font-black uppercase tracking-widest leading-loose">
    우테코 크루를 위한 고성능 영양 분석 도구<br/>
    Powered by Gemini 2.5 Flash
</footer>

<script>
    const apiKey = "";
    let currentGoal = '';

    const loadingOverlay = document.getElementById('loadingOverlay');
    const mealListContainer = document.getElementById('mealList');
    const fileInput = document.getElementById('fileInput');
    const previewImg = document.getElementById('previewImg');
    const imagePreview = document.getElementById('imagePreview');
    const uploadPrompt = document.getElementById('uploadPrompt');
    const inputSection = document.getElementById('inputSection');
    const resultSection = document.getElementById('resultSection');
    const errorMessage = document.getElementById('errorMessage');

    window.onload = () => {
        addMealField('');
        addMealField('');
    };

    function setGoal(goal) {
        currentGoal = goal;
        errorMessage.classList.add('hidden');
        document.getElementById('goalDiet').className = goal === 'diet'
            ? 'flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-orange-400 bg-orange-50 text-orange-700 shadow-lg scale-[1.02] transition-all'
            : 'flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-200 bg-white text-slate-400 transition-all';

        document.getElementById('goalBulk').className = goal === 'bulk'
            ? 'flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-blue-400 bg-blue-50 text-blue-700 shadow-lg scale-[1.02] transition-all'
            : 'flex flex-col items-center justify-center p-6 rounded-3xl border-2 border-slate-200 bg-white text-slate-400 transition-all';
    }

    function addMealField(value = '') {
        const id = Date.now() + Math.random();
        const div = document.createElement('div');
        div.id = `meal-${id}`;
        div.className = 'bg-white rounded-3xl p-5 shadow-sm border border-slate-100 flex gap-4 animate-fade-in';
        div.innerHTML = `
                <div class="w-10 h-10 bg-slate-50 rounded-2xl flex items-center justify-center shrink-0 border border-slate-100 shadow-inner">
                    <span class="text-xs font-black text-slate-400 meal-index">01</span>
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-black text-slate-300 uppercase tracking-tighter">Meal Content</span>
                        <button onclick="removeMealField('${id}')" class="text-slate-200 hover:text-red-400 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <textarea class="meal-input w-full bg-transparent border-none focus:ring-0 p-0 text-slate-800 font-bold text-base placeholder:text-slate-200 resize-none overflow-hidden" rows="2" placeholder="식단을 입력하세요" oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'">${value}</textarea>
                </div>
            `;
        mealListContainer.appendChild(div);
        updateIndices();
    }

    function removeMealField(id) {
        const fields = document.querySelectorAll('.meal-input');
        if (fields.length <= 1) {
            fields[0].value = '';
            return;
        };
        const target = document.getElementById(`meal-${id}`);
        if(target) target.remove();
        updateIndices();
    }

    function updateIndices() {
        const indices = document.querySelectorAll('.meal-index');
        indices.forEach((el, i) => {
            el.innerText = (i + 1).toString().padStart(2, '0');
        });
    }

    function showError(msg) {
        errorMessage.classList.remove('hidden');
        document.getElementById('errorText').innerText = msg;
        errorMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function clearImage() {
        fileInput.value = '';
        previewImg.src = '';
        imagePreview.classList.add('hidden');
        uploadPrompt.classList.remove('hidden');
        mealListContainer.innerHTML = '';
        addMealField('');
        addMealField('');
        errorMessage.classList.add('hidden');
    }

    fileInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        errorMessage.classList.add('hidden');
        const reader = new FileReader();
        reader.onload = async (e) => {
            const base64Data = e.target.result.split(',')[1];
            try {
                showLoading('extract');
                const result = await extractMenus(base64Data);
                if (result.isDietImage) {
                    previewImg.src = e.target.result;
                    imagePreview.classList.remove('hidden');
                    uploadPrompt.classList.add('hidden');
                    mealListContainer.innerHTML = '';
                    if (result.menus && result.menus.length > 0) {
                        result.menus.forEach(m => addMealField(m));
                        if(result.menus.length < 2) addMealField('');
                    } else {
                        addMealField('');
                        addMealField('');
                    }
                } else {
                    clearImage();
                    showError('식단 정보를 찾을 수 없습니다.');
                }
            } catch (err) {
                clearImage();
                showError('이미지 분석 중 오류가 발생했습니다.');
            } finally {
                hideLoading();
            }
        };
        reader.readAsDataURL(file);
    });

    async function extractMenus(base64) {
        const prompt = `이미지를 분석하여 식단(Meal) 정보를 추출하세요.
            [추출 가이드]
            1. 이미지 내에서 식단표의 각 칸(날짜/코너별 구분)을 식별하세요.
            2. 각 식단 칸에 있는 모든 메뉴(메인 메뉴 + 국 + 반찬들)를 하나의 문자열로 묶으세요.
            3. 예시: "소고기무국, 쌀밥, 메밀전병*초간장, 천사채샐러드, 모듬콩자반" 과 같이 콤마로 구분하세요.
            4. 'isDietImage' 필드에 식단 관련 정보가 있으면 true, 아니면 false를 넣으세요.
            5. 'menus' 필드에 추출된 각 식단 문자열들을 배열로 담으세요.
            응답 형식: { "isDietImage": boolean, "menus": ["메인1, 반찬1, 반찬2", "메인2, 반찬3, 반찬4"] }`;

        const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64 } }] }],
                generationConfig: { responseMimeType: "application/json" }
            })
        });
        const data = await response.json();
        return JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text);
    }

    async function analyzeDiet() {
        if (!currentGoal) return showError('목표를 먼저 선택해주세요!');
        const inputs = document.querySelectorAll('.meal-input');
        const validMeals = Array.from(inputs).map(i => i.value).filter(v => v.trim() !== '');
        if (validMeals.length < 2) return showError('비교 분석을 위해 최소 2개 이상의 식단을 입력해주세요!');

        errorMessage.classList.add('hidden');
        showLoading('analyze');

        const mealStrings = validMeals.join(' [다음식단] ');
        const systemPrompt = `당신은 영양사입니다. 제공된 '식단 리스트' 중에서 사용자의 목표에 가장 적합한 한 세트를 선택하세요.
            [엄격한 규칙]
            1. 'bestMeal'은 반드시 사용자가 제공한 '식단 리스트' 중 하나여야 합니다. 리스트에 없는 메뉴를 추천하지 마세요.
            2. 'bestReason'은 영양학적 관점에서 왜 이 식단 세트가 목표에 좋은지 1문장으로 설명하세요.
            3. 'tips'는 구체적인 식사 가이드를 2~3개 제공하세요.
            응답 형식: { "bestMeal": "리스트 내의 식단 내용 전체", "bestReason": "이유", "tips": ["팁1", "팁2"] }`;

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: `목표: ${currentGoal === 'diet' ? '다이어트' : '증량'}, 식단 리스트: ${mealStrings}` }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                    generationConfig: { responseMimeType: "application/json" }
                })
            });
            const data = await response.json();
            const result = JSON.parse(data.candidates[0].content.parts[0].text);
            renderResult(result);
        } catch (err) {
            showError('분석 중 오류가 발생했습니다.');
        } finally {
            hideLoading();
        }
    }

    function renderResult(res) {
        // 결과 메뉴 출력 시 콤마를 줄바꿈이나 보기 좋은 형태로 가공
        const mealDisplay = res.bestMeal.split(',')[0].trim();
        document.getElementById('resBestMeal').innerText = mealDisplay;
        document.getElementById('resBestReason').innerText = `"${res.bestReason}"`;
        const tipsUl = document.getElementById('resTips');
        tipsUl.innerHTML = res.tips.map(tip => `
                <li class="flex gap-4 items-start font-bold text-lg leading-snug text-left">
                    <span class="text-yellow-400 shrink-0 font-black text-2xl leading-none">·</span>
                    ${tip}
                </li>
            `).join('');
        inputSection.classList.add('hidden');
        resultSection.classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function goBack() {
        resultSection.classList.add('hidden');
        inputSection.classList.remove('hidden');
    }

    function showLoading(type) {
        document.getElementById('loadingTitle').innerText = type === 'extract' ? '식단표 해독 중...' : '영양 성분 분석 중...';
        document.getElementById('loadingDesc').innerText = 'AI가 식단 조합을 꼼꼼하게 살피고 있습니다.';
        loadingOverlay.classList.remove('hidden');
        loadingOverlay.classList.add('flex');
    }

    function hideLoading() {
        loadingOverlay.classList.add('hidden');
        loadingOverlay.classList.remove('flex');
    }
</script>
</body>
</html>